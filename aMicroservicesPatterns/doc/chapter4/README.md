# 使用Saga管理事务

Saga是一种在微服务架构中维护数据一致性的机制, 它可以避免分布式事务所带来的问题. 
Saga由一连串的本地事务组成(通过异步消息来协调), 每个本地事务负责更新它所在服务的私有数据库.

跨服务的操作必须使用所谓的Saga(一种消息驱动的本地事务序列)来维护数据一致性, 而不是ACID事务(原子性、一致性、
隔离性和持久性). 

但是Saga只满足ACD(原子性、一致性和持久性).

## Saga使用补偿事务来回滚所做出的改变
Saga无法自动回滚, 必须编写`补偿事务`. 当第n+1个事务失败, 则必须撤销前n个事务的影响(按照事务的反向顺序)


## 两种模式

### 协调模式

当通过系统命令启动Saga时, 协调逻辑必须选择并通知第一个Saga参与方. 这个过程一直持续到Saga执行完所有步骤.
如果任何本地事务失败, 则Saga必须以相反的顺序执行补偿事务. 

几种构建Saga协调逻辑的方法:
- 协同式: 把Saga的决策和执行顺序逻辑分布在Saga的每一个参与方中, 它们通过交换事件的方式来进行沟通.
- 编排式: 把Saga的决策和执行顺序逻辑集中在一个Saga编排器类中. Saga编排器发出命令式消息给各个Saga参与方, 
指示这些参与方服务完成具体操作(本地事务).

## Saga
### 事务
- 可补偿性事务: 可以使用补偿事务回滚的事务
- 关键性事务: Saga执行过程的关键点. 如果关键性事务成功, 则Saga将一直运行到完成. 关键事务不见得是一个可补偿性事务
, 或者可重复性事务. 但是它可以是最后一个可补偿的事务或第一个可重复的事务.
- 可重复性事务:在关键性事务之后的事务, 保证成功.

## 隔离问题

使用`语以锁`来解决Saga模式下的隔离问题. 语义锁是应用程序级的锁


https://github.com/lysu/go-saga